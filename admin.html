<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin ¬∑ Welcome Pack</title>
  <style>
    :root{--bg:#f6f7f9;--card:#fff;--text:#0f172a;--muted:#64748b;--danger:#b91c1c;--ok:#166534;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:1120px;margin:0 auto;padding:24px 16px 90px;}
    h1{margin:0 0 12px;font-size:28px;}
    .card{background:var(--card);border-radius:18px;box-shadow:0 6px 18px rgba(15,23,42,.08);padding:18px;margin-bottom:14px;}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    input{flex:1;min-width:240px;padding:14px 16px;border-radius:14px;border:1px solid #e2e8f0;font-size:18px;}
    button{padding:12px 16px;border-radius:14px;border:0;background:#000;color:#fff;font-size:16px;cursor:pointer;}
    button:disabled{opacity:.6;cursor:not-allowed;}
    table{width:100%;border-collapse:collapse;margin-top:12px;display:block;overflow:auto;}
    th,td{padding:10px 12px;border-bottom:1px solid #e2e8f0;white-space:nowrap;}
    th{background:#f1f5f9;font-weight:700;position:sticky;top:0;}
    .alert{padding:12px 14px;border-radius:14px;background:#fee2e2;color:var(--danger);border:1px solid #fecaca;margin-top:10px;}
    .ok{padding:12px 14px;border-radius:14px;background:#dcfce7;color:var(--ok);border:1px solid #bbf7d0;margin-top:10px;}

    /* Bottom tabs */
    .tabs{
      position:fixed;left:0;right:0;bottom:0;
      background:#fff;border-top:1px solid #e2e8f0;
      display:flex;gap:10px;justify-content:center;
      padding:10px;
      z-index:50;
    }
    .tabbtn{
      flex:1;max-width:220px;
      background:#f1f5f9;color:#0f172a;
      border-radius:16px;padding:10px 12px;
      display:flex;align-items:center;justify-content:center;
      gap:8px;font-weight:700;
    }
    .tabbtn.active{background:#0f172a;color:#fff;}
    .hidden{display:none;}

    /* Modal */
    .modalOverlay{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:99;}
    .modal{background:#fff;border-radius:18px;max-width:520px;width:100%;padding:18px;box-shadow:0 18px 40px rgba(0,0,0,.25);}
    .modal h3{margin:0 0 8px;}
    .modal p{margin:0 0 14px;color:var(--muted);}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;}
    .btnGhost{background:#e2e8f0;color:#0f172a;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Panel de Supervisi√≥n ¬∑ Welcome Pack</h1>

    <!-- REGISTRAR -->
    <section id="view-registrar" class="card">
      <h2 style="margin:0 0 10px;">Registrar entrega (admin)</h2>

      <div class="row">
        <input id="rutBuscar" placeholder="RUT abonado o comprador (con o sin gui√≥n)" />
        <button id="btnBuscar">Buscar</button>
      </div>

      <div id="buscarMsg"></div>

      <div id="groupBox" style="display:none;margin-top:10px;">
        <div id="groupHeader" style="font-weight:800;margin-bottom:8px;"></div>
        <div id="groupSummary" style="color:var(--muted);margin-bottom:10px;"></div>

        <table>
          <thead>
            <tr>
              <th>Rut</th><th>Nombre</th><th>Categor√≠a</th><th>Tribuna</th><th>Sector</th>
            </tr>
          </thead>
          <tbody id="groupTbody"></tbody>
        </table>

        <div id="alreadyBox"></div>

        <div id="formEntrega" style="margin-top:14px;">
          <h3 style="margin:0 0 10px;">Datos del receptor</h3>
          <div class="row">
            <input id="rutReceptor" placeholder="RUT receptor (con o sin gui√≥n)"/>
            <input id="nombreReceptor" placeholder="Nombre receptor"/>
            <button id="btnGuardar">Guardar entrega</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ENTREGAS -->
    <section id="view-entregas" class="card hidden">
      <h2 style="margin:0 0 10px;">Entregas registradas (log)</h2>
      <div class="row">
        <input id="qLog" placeholder="Buscar por RUT comprador o receptor..." />
        <button id="btnLog">Actualizar</button>
      </div>
      <div id="logMsg"></div>
      <table>
        <thead>
          <tr>
            <th>Rut comprador</th>
            <th>Rut receptor</th>
            <th>Nombre receptor</th>
            <th>Fecha/hora (ISO)</th>
          </tr>
        </thead>
        <tbody id="logTbody"></tbody>
      </table>
    </section>

    <!-- EXPORTAR -->
    <section id="view-exportar" class="card hidden">
      <h2 style="margin:0 0 10px;">Exportar</h2>
      <div class="row">
        <button onclick="window.open('/.netlify/functions/export_base','_blank')">Descargar base (CSV)</button>
        <button onclick="window.open('/.netlify/functions/export_log','_blank')">Descargar entregas (CSV)</button>
        <button onclick="window.open('/.netlify/functions/export_pendientes','_blank')">Descargar pendientes (CSV)</button>
      </div>
      <div style="color:var(--muted);margin-top:10px;">
        * ‚ÄúPendientes‚Äù = grupos cuyo <b>rut_comprador</b> a√∫n no est√° en el log de Blobs.
      </div>
    </section>

    <!-- REPORTE (placeholder simple: usa buscar + log si quieres luego) -->
    <section id="view-reporte" class="card hidden">
      <h2 style="margin:0 0 10px;">Reporte</h2>
      <div style="color:var(--muted);">Si quieres, aqu√≠ armamos el buscador avanzado + tabla consolidada.</div>
    </section>

    <!-- METRICAS -->
    <section id="view-metricas" class="card hidden">
      <h2 style="margin:0 0 10px;">M√©tricas</h2>
      <button id="btnMetrics">Cargar m√©tricas</button>
      <div id="metricsBox" style="margin-top:10px;"></div>
    </section>
  </div>

  <!-- TABS ABAJO -->
  <div class="tabs">
    <div class="tabbtn active" data-tab="registrar">üìù Registrar</div>
    <div class="tabbtn" data-tab="entregas">üì¶ Entregas</div>
    <div class="tabbtn" data-tab="exportar">‚¨áÔ∏è Exportar</div>
    <div class="tabbtn" data-tab="reporte">üìã Reporte</div>
    <div class="tabbtn" data-tab="metricas">üìä M√©tricas</div>
  </div>

  <!-- MODAL -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal">
      <h3 id="modalTitle">Aviso</h3>
      <p id="modalText"></p>
      <div class="actions">
        <button class="btnGhost" id="modalClose">Cerrar</button>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  // modal
  const modalOverlay = $("modalOverlay");
  const modalTitle = $("modalTitle");
  const modalText = $("modalText");
  const modalClose = $("modalClose");
  function showModal(title, text){
    modalTitle.textContent = title || "Aviso";
    modalText.textContent = text || "";
    modalOverlay.style.display = "flex";
  }
  modalClose.onclick = ()=> modalOverlay.style.display="none";
  modalOverlay.addEventListener("click",(e)=>{ if(e.target===modalOverlay) modalOverlay.style.display="none"; });

  // tabs
  const views = {
    registrar: $("view-registrar"),
    entregas: $("view-entregas"),
    exportar: $("view-exportar"),
    reporte: $("view-reporte"),
    metricas: $("view-metricas")
  };
  document.querySelectorAll(".tabbtn").forEach(btn=>{
    btn.onclick = ()=>{
      document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      Object.values(views).forEach(v=>v.classList.add("hidden"));
      views[btn.dataset.tab].classList.remove("hidden");
    };
  });

  // registrar
  const rutBuscar = $("rutBuscar");
  const btnBuscar = $("btnBuscar");
  const buscarMsg = $("buscarMsg");
  const groupBox = $("groupBox");
  const groupHeader = $("groupHeader");
  const groupSummary = $("groupSummary");
  const groupTbody = $("groupTbody");
  const alreadyBox = $("alreadyBox");
  const rutReceptor = $("rutReceptor");
  const nombreReceptor = $("nombreReceptor");
  const btnGuardar = $("btnGuardar");

  let lastData = null;

  function setMsg(el, type, text){
    el.innerHTML = "";
    if(!text) return;
    const div = document.createElement("div");
    div.className = (type==="ok") ? "ok" : "alert";
    div.textContent = text;
    el.appendChild(div);
  }

  function renderGroup(data){
    lastData = data;
    groupBox.style.display = "block";
    groupTbody.innerHTML = "";
    alreadyBox.innerHTML = "";

    groupHeader.textContent =
      `Estado: ${data.status} ¬∑ RUT buscado: ${data.buscado.rut} ¬∑ Nombre: ${data.buscado.nombre || "-"}`;
    groupSummary.textContent =
      `Comprador: ${data.comprador.nombre || "-"} (${data.comprador.rut}) ¬∑ Resumen packs: ${data.resumen.join(", ")}`;

    data.miembros.forEach(m=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${m.rut}</td><td>${m.nombre||""}</td><td>${m.categoria||""}</td><td>${m.tribuna||""}</td><td>${m.sector||""}</td>`;
      groupTbody.appendChild(tr);
    });

    if(data.status === "YA_ENTREGADO"){
      const div = document.createElement("div");
      div.className = "ok";
      div.textContent = "Este grupo ya aparece como ENTREGADO (seg√∫n base).";
      alreadyBox.appendChild(div);
    }
  }

  async function buscar(){
    const rut = rutBuscar.value.trim();
    setMsg(buscarMsg, "", "");
    groupBox.style.display = "none";
    lastData = null;

    if(!rut){
      showModal("Falta RUT", "Ingresa un RUT para buscar.");
      return;
    }

    btnBuscar.disabled = true;
    try{
      const res = await fetch(`/.netlify/functions/buscar?rut=${encodeURIComponent(rut)}`);
      const data = await res.json();

      if(data.status === "NO_ENCONTRADO"){
        showModal("No encontrado", "No se encontr√≥ el RUT en la base.");
        return;
      }
      if(data.status === "SIN_GRUPO"){
        showModal("Sin grupo", "Se encontr√≥ el RUT, pero no se pudo armar el grupo del comprador.");
        return;
      }
      if(data.status === "ERROR"){
        showModal("Error", data.error || "Error desconocido");
        return;
      }

      renderGroup(data);
    }catch(e){
      showModal("Error al cargar", String(e?.message || e));
    }finally{
      btnBuscar.disabled = false;
    }
  }

  btnBuscar.onclick = buscar;
  rutBuscar.addEventListener("keydown",(e)=>{ if(e.key==="Enter") buscar(); });

  async function guardar(){
    if(!lastData){
      showModal("Sin grupo", "Primero busca un RUT.");
      return;
    }

    const body = {
      rut_comprador: lastData.comprador.rut,
      rut_receptor: rutReceptor.value.trim(),
      nombre_receptor: nombreReceptor.value.trim()
    };

    if(!body.rut_receptor || !body.nombre_receptor){
      showModal("Faltan datos", "Completa RUT receptor y nombre receptor.");
      return;
    }

    btnGuardar.disabled = true;
    try{
      const res = await fetch("/.netlify/functions/entregar", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();

      if(data.status === "YA_ENTREGADO"){
        showModal("Ya entregado", "Este grupo ya ten√≠a entrega registrada en el log.");
        return;
      }
      if(data.status !== "OK"){
        showModal("Error", data.error || "No se pudo guardar.");
        return;
      }

      showModal("Listo ‚úÖ", "Entrega registrada correctamente.");
      rutReceptor.value = "";
      nombreReceptor.value = "";
    }catch(e){
      showModal("Error", String(e?.message || e));
    }finally{
      btnGuardar.disabled = false;
    }
  }

  btnGuardar.onclick = guardar;

  // Entregas tab
  const qLog = $("qLog");
  const btnLog = $("btnLog");
  const logMsg = $("logMsg");
  const logTbody = $("logTbody");

  async function cargarLog(){
    setMsg(logMsg, "", "");
    logTbody.innerHTML = "";
    btnLog.disabled = true;

    try{
      const res = await fetch("/.netlify/functions/get_log");
      const data = await res.json();
      if(data.status !== "OK"){
        setMsg(logMsg, "err", data.error || "No se pudo cargar log");
        return;
      }

      const q = (qLog.value || "").trim().toUpperCase();
      const items = (data.items || []).filter(x=>{
        if(!q) return true;
        return String(x.rut_comprador||"").toUpperCase().includes(q)
          || String(x.rut_receptor||"").toUpperCase().includes(q)
          || String(x.nombre_receptor||"").toUpperCase().includes(q);
      });

      items.forEach(x=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${x.rut_comprador||""}</td>
          <td>${x.rut_receptor||""}</td>
          <td>${x.nombre_receptor||""}</td>
          <td>${x.fecha_iso||""}</td>
        `;
        logTbody.appendChild(tr);
      });

      if(!items.length) setMsg(logMsg, "err", "Sin datos para mostrar.");
    }catch(e){
      setMsg(logMsg, "err", String(e?.message || e));
    }finally{
      btnLog.disabled = false;
    }
  }

  btnLog.onclick = cargarLog;

  // M√©tricas tab
  const btnMetrics = $("btnMetrics");
  const metricsBox = $("metricsBox");
  btnMetrics.onclick = async ()=>{
    metricsBox.innerHTML = "";
    btnMetrics.disabled = true;
    try{
      const res = await fetch("/.netlify/functions/metrics");
      const data = await res.json();
      if(data.status !== "OK"){
        metricsBox.innerHTML = `<div class="alert">${data.error || "No se pudo cargar m√©tricas"}</div>`;
        return;
      }
      metricsBox.innerHTML = `<div class="ok">Total entregas registradas: <b>${data.total_entregas}</b></div>`;
    }catch(e){
      metricsBox.innerHTML = `<div class="alert">${String(e?.message || e)}</div>`;
    }finally{
      btnMetrics.disabled = false;
    }
  };
</script>
</body>
</html>
