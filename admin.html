<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin ¬∑ Welcome Pack</title>
  <style>
    :root{--bg:#f6f7f9;--card:#fff;--text:#0f172a;--muted:#64748b;--danger:#b91c1c;--ok:#166534;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:1120px;margin:0 auto;padding:24px 16px 90px;}
    h1{margin:0 0 12px;font-size:28px;}
    .card{background:var(--card);border-radius:18px;box-shadow:0 6px 18px rgba(15,23,42,.08);padding:18px;margin-bottom:14px;}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    input{flex:1;min-width:240px;padding:14px 16px;border-radius:14px;border:1px solid #e2e8f0;font-size:18px;}
    button{padding:12px 16px;border-radius:14px;border:0;background:#000;color:#fff;font-size:16px;cursor:pointer;}
    button:disabled{opacity:.6;cursor:not-allowed;}
    table{width:100%;border-collapse:collapse;margin-top:12px;display:block;overflow:auto;}
    th,td{padding:10px 12px;border-bottom:1px solid #e2e8f0;white-space:nowrap;}
    th{background:#f1f5f9;font-weight:700;position:sticky;top:0;}
    .alert{padding:12px 14px;border-radius:14px;background:#fee2e2;color:var(--danger);border:1px solid #fecaca;margin-top:10px;}
    .ok{padding:12px 14px;border-radius:14px;background:#dcfce7;color:var(--ok);border:1px solid #bbf7d0;margin-top:10px;}
    .hidden{display:none;}

    /* Bottom tabs (con scroll horizontal por si no caben) */
    .tabs{
      position:fixed;left:0;right:0;bottom:0;
      background:#fff;border-top:1px solid #e2e8f0;
      display:flex;gap:10px;justify-content:flex-start;
      padding:10px;
      z-index:50;

      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      white-space:nowrap;
    }
    .tabs::-webkit-scrollbar{display:none;}

    .tabbtn{
      flex:0 0 auto;
      min-width:150px;
      background:#f1f5f9;color:#0f172a;
      border-radius:16px;padding:10px 12px;
      display:inline-flex;align-items:center;justify-content:center;
      gap:8px;font-weight:700;
      user-select:none;
    }
    .tabbtn.active{background:#0f172a;color:#fff;}

    /* Modal */
    .modalOverlay{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:99;}
    .modal{background:#fff;border-radius:18px;max-width:520px;width:100%;padding:18px;box-shadow:0 18px 40px rgba(0,0,0,.25);}
    .modal h3{margin:0 0 8px;}
    .modal p{margin:0 0 14px;color:var(--muted);}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;}
    .btnGhost{background:#e2e8f0;color:#0f172a;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Panel de Supervisi√≥n ¬∑ Welcome Pack</h1>

    <!-- REGISTRAR -->
    <section id="view-registrar" class="card">
      <h2 style="margin:0 0 10px;">Registrar entrega (admin)</h2>

      <div class="row">
        <input id="rutBuscar" placeholder="RUT abonado o comprador (con o sin gui√≥n)" />
        <button id="btnBuscar">Buscar</button>
      </div>

      <div id="groupBox" style="display:none;margin-top:10px;">
        <div id="groupHeader" style="font-weight:800;margin-bottom:8px;"></div>
        <div id="groupSummary" style="color:var(--muted);margin-bottom:10px;"></div>

        <table>
          <thead>
            <tr>
              <th>Rut</th><th>Nombre</th><th>Categor√≠a</th><th>Tribuna</th><th>Sector</th>
            </tr>
          </thead>
          <tbody id="groupTbody"></tbody>
        </table>

        <div id="alreadyBox"></div>

        <div id="formEntrega" style="margin-top:14px;">
          <h3 style="margin:0 0 10px;">Datos del receptor</h3>
          <div class="row">
            <input id="rutReceptor" placeholder="RUT receptor (con o sin gui√≥n)"/>
            <input id="nombreReceptor" placeholder="Nombre receptor"/>
            <button id="btnGuardar">Guardar entrega</button>
          </div>
        </div>
      </div>
    </section>

    <!-- EXPORTAR -->
    <section id="view-exportar" class="card hidden">
      <h2 style="margin:0 0 10px;">Exportar</h2>
      <div class="row">
        <button onclick="window.open('/.netlify/functions/export_base','_blank')">Descargar base (Excel)</button>
        <button onclick="window.open('/.netlify/functions/export_log','_blank')">Descargar entregas (Excel)</button>
      </div>
      <div style="color:var(--muted);margin-top:10px;">
        * Descargas pensadas para abrir directo en Excel.
      </div>
    </section>

    <!-- METRICAS -->
    <section id="view-metricas" class="card hidden">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <h2 style="margin:0;">M√©tricas (resumen)</h2>
        <button id="btnMetrics">Actualizar</button>
      </div>
      <div id="metricsOut" style="margin-top:12px;"></div>
    </section>
  </div>

  <!-- TABS ABAJO -->
  <div class="tabs">
    <div class="tabbtn active" data-tab="registrar">üìù Registrar</div>
    <div class="tabbtn" data-tab="exportar">‚¨áÔ∏è Exportar</div>
    <div class="tabbtn" data-tab="metricas">üìä M√©tricas</div>
  </div>

  <!-- MODAL -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal">
      <h3 id="modalTitle">Aviso</h3>
      <p id="modalText"></p>
      <div class="actions">
        <button class="btnGhost" id="modalClose">Cerrar</button>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  // modal
  const modalOverlay = $("modalOverlay");
  const modalTitle = $("modalTitle");
  const modalText = $("modalText");
  const modalClose = $("modalClose");
  function showModal(title, text){
    modalTitle.textContent = title || "Aviso";
    modalText.textContent = text || "";
    modalOverlay.style.display = "flex";
  }
  modalClose.onclick = ()=> modalOverlay.style.display="none";
  modalOverlay.addEventListener("click",(e)=>{ if(e.target===modalOverlay) modalOverlay.style.display="none"; });

  function esc(s){
    return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
  function pct(x){ return `${Math.round((x||0)*1000)/10}%`; } // 1 decimal

  // views / tabs
  const views = {
    registrar: $("view-registrar"),
    exportar: $("view-exportar"),
    metricas: $("view-metricas")
  };

  document.querySelectorAll(".tabbtn").forEach(btn=>{
    btn.onclick = ()=>{
      document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      Object.values(views).forEach(v=>v.classList.add("hidden"));
      views[btn.dataset.tab].classList.remove("hidden");

      if(btn.dataset.tab === "metricas") cargarMetricas();
    };
  });

  // registrar
  const rutBuscar = $("rutBuscar");
  const btnBuscar = $("btnBuscar");
  const groupBox = $("groupBox");
  const groupHeader = $("groupHeader");
  const groupSummary = $("groupSummary");
  const groupTbody = $("groupTbody");
  const alreadyBox = $("alreadyBox");
  const formEntrega = $("formEntrega");
  const rutReceptor = $("rutReceptor");
  const nombreReceptor = $("nombreReceptor");
  const btnGuardar = $("btnGuardar");

  let lastData = null;

  function renderGroup(data){
    lastData = data;
    groupBox.style.display = "block";
    groupTbody.innerHTML = "";
    alreadyBox.innerHTML = "";

    groupHeader.textContent =
      `Estado: ${data.status} ¬∑ RUT buscado: ${data.buscado.rut} ¬∑ Nombre: ${data.buscado.nombre || "-"}`;
    groupSummary.textContent =
      `Comprador: ${data.comprador.nombre || "-"} (${data.comprador.rut}) ¬∑ Resumen packs: ${(data.resumen||[]).join(", ")}`;

    (data.miembros || []).forEach(m=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${esc(m.rut)}</td><td>${esc(m.nombre||"")}</td><td>${esc(m.categoria||"")}</td><td>${esc(m.tribuna||"")}</td><td>${esc(m.sector||"")}</td>`;
      groupTbody.appendChild(tr);
    });

    const isEntregado = (data.status === "YA_ENTREGADO");
    formEntrega.style.display = isEntregado ? "none" : "block";

    if(isEntregado){
      const div = document.createElement("div");
      div.className = "ok";
      div.textContent = "Este grupo ya aparece como ENTREGADO.";
      alreadyBox.appendChild(div);
    } else {
      rutReceptor.value = "";
      nombreReceptor.value = "";
    }
  }

  async function buscar(){
    const rut = rutBuscar.value.trim();
    groupBox.style.display = "none";
    lastData = null;

    if(!rut){
      showModal("Falta RUT", "Ingresa un RUT para buscar.");
      return;
    }

    btnBuscar.disabled = true;
    try{
      const res = await fetch(`/.netlify/functions/buscar?rut=${encodeURIComponent(rut)}`);
      const data = await res.json();

      if(data.status === "NO_ENCONTRADO"){ showModal("No encontrado", "No se encontr√≥ el RUT en la base."); return; }
      if(data.status === "SIN_GRUPO"){ showModal("Sin grupo", "Se encontr√≥ el RUT, pero no se pudo armar el grupo del comprador."); return; }
      if(data.status === "ERROR"){ showModal("Error", data.error || "Error desconocido"); return; }

      renderGroup(data);
    }catch(e){
      showModal("Error al cargar", String(e?.message || e));
    }finally{
      btnBuscar.disabled = false;
    }
  }

  btnBuscar.onclick = buscar;
  rutBuscar.addEventListener("keydown",(e)=>{ if(e.key==="Enter") buscar(); });

  async function guardar(){
    if(!lastData){
      showModal("Sin grupo", "Primero busca un RUT.");
      return;
    }
    if(lastData.status === "YA_ENTREGADO"){
      showModal("Ya entregado", "Este grupo ya aparece como entregado.");
      return;
    }

    const rutBuscado = rutBuscar.value.trim();

    const body = {
      rut_buscado: rutBuscado,
      rut_receptor: rutReceptor.value.trim(),
      nombre_receptor: nombreReceptor.value.trim()
    };

    if(!body.rut_receptor || !body.nombre_receptor){
      showModal("Faltan datos", "Completa RUT receptor y nombre receptor.");
      return;
    }

    btnGuardar.disabled = true;
    try{
      const res = await fetch("/.netlify/functions/entregar", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();

      if(data.status === "YA_ENTREGADO"){
        showModal("Ya entregado", "Este grupo ya ten√≠a entrega registrada.");
        return;
      }
      if(data.status !== "OK"){
        showModal("Error", data.error || "No se pudo guardar.");
        return;
      }

      showModal("Listo ‚úÖ", "Entrega guardada correctamente.");
      await buscar();

      rutReceptor.value = "";
      nombreReceptor.value = "";
    }catch(e){
      showModal("Error", String(e?.message || e));
    }finally{
      btnGuardar.disabled = false;
    }
  }

  btnGuardar.onclick = guardar;

  // M√©tricas
  const btnMetrics = $("btnMetrics");
  const metricsOut = $("metricsOut");
  btnMetrics.onclick = cargarMetricas;

  async function cargarMetricas(){
    metricsOut.innerHTML = "Cargando...";
    btnMetrics.disabled = true;

    try{
      const res = await fetch("/.netlify/functions/metrics");
      const data = await res.json();

      if(!res.ok || data.status !== "OK"){
        metricsOut.innerHTML = `<div class="alert">Error: ${esc(data.error || "No se pudo cargar")}</div>`;
        return;
      }

      let html = `
        <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;">
          <div style="padding:14px;border:1px solid #e2e8f0;border-radius:16px;background:#fff;">
            <div style="color:#64748b;font-weight:700;">Total abonados</div>
            <div style="font-size:34px;font-weight:900;line-height:1.1;">${data.total_base}</div>
          </div>

          <div style="padding:14px;border:1px solid #e2e8f0;border-radius:16px;background:#fff;">
            <div style="color:#64748b;font-weight:700;">Entregados</div>
            <div style="font-size:34px;font-weight:900;line-height:1.1;">${data.total_entregados}</div>
          </div>

          <div style="padding:14px;border:1px solid #e2e8f0;border-radius:16px;background:#fff;">
            <div style="color:#64748b;font-weight:700;">% Entrega</div>
            <div style="font-size:34px;font-weight:900;line-height:1.1;">${pct(data.pct_total)}</div>
          </div>
        </div>
      `;

      html += `
        <h3 style="margin:16px 0 8px;">Por categor√≠a</h3>
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left;border-bottom:1px solid #e2e8f0;padding:10px 12px;">Categor√≠a</th>
              <th style="text-align:right;border-bottom:1px solid #e2e8f0;padding:10px 12px;">Entregados</th>
              <th style="text-align:right;border-bottom:1px solid #e2e8f0;padding:10px 12px;">Total</th>
              <th style="text-align:right;border-bottom:1px solid #e2e8f0;padding:10px 12px;">% Entreg</th>
            </tr>
          </thead>
          <tbody>
            ${(data.por_categoria||[]).map(r => `
              <tr>
                <td style="padding:10px 12px;border-bottom:1px solid #f1f5f9;">${esc(r.categoria)}</td>
                <td style="padding:10px 12px;border-bottom:1px solid #f1f5f9;text-align:right;">${r.entregados}</td>
                <td style="padding:10px 12px;border-bottom:1px solid #f1f5f9;text-align:right;">${r.base}</td>
                <td style="padding:10px 12px;border-bottom:1px solid #f1f5f9;text-align:right;">${pct(r.pct)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

      const rows = (data.por_ubicacion || []);
      html += `
        <h3 style="margin:16px 0 8px;">Por ubicaci√≥n</h3>
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left;border-bottom:1px solid #e2e8f0;padding:10px 12px;">Ubicaci√≥n</th>
              <th style="text-align:right;border-bottom:1px solid #e2e8f0;padding:10px 12px;">Entregados</th>
              <th style="text-align:right;border-bottom:1px solid #e2e8f0;padding:10px 12px;">Total</th>
              <th style="text-align:right;border-bottom:1px solid #e2e8f0;padding:10px 12px;">% Entreg</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td style="padding:10px 12px;border-bottom:1px solid #f1f5f9;">${esc(r.ubicacion)}</td>
                <td style="padding:10px 12px;border-bottom:1px solid #f1f5f9;text-align:right;">${r.entregados}</td>
                <td style="padding:10px 12px;border-bottom:1px solid #f1f5f9;text-align:right;">${r.base}</td>
                <td style="padding:10px 12px;border-bottom:1px solid #f1f5f9;text-align:right;">${pct(r.pct)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

      metricsOut.innerHTML = html;

    }catch(e){
      metricsOut.innerHTML = `<div class="alert">${esc(String(e?.message || e))}</div>`;
    }finally{
      btnMetrics.disabled = false;
    }
  }
</script>
</body>
</html>
