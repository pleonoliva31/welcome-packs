<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin ¬∑ Welcome Pack</title>
  <style>
    :root{--bg:#f6f7f9;--card:#fff;--text:#0f172a;--muted:#64748b;--danger:#b91c1c;--ok:#166534;--line:#e2e8f0;--dangerbg:#fee2e2;--okbg:#dcfce7;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:1120px;margin:0 auto;padding:24px 16px 90px;}
    h1{margin:0 0 12px;font-size:28px;}
    .card{background:var(--card);border-radius:18px;box-shadow:0 6px 18px rgba(15,23,42,.08);padding:18px;margin-bottom:14px;border:1px solid var(--line);}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    input{flex:1;min-width:240px;padding:14px 16px;border-radius:14px;border:1px solid #e2e8f0;font-size:18px;}
    button{padding:12px 16px;border-radius:14px;border:0;background:#000;color:#fff;font-size:16px;cursor:pointer;}
    button:disabled{opacity:.6;cursor:not-allowed;}
    table{width:100%;border-collapse:collapse;margin-top:12px;display:block;overflow:auto;}
    th,td{padding:10px 12px;border-bottom:1px solid #e2e8f0;white-space:nowrap;}
    th{background:#f1f5f9;font-weight:700;position:sticky;top:0;}
    .alert{padding:12px 14px;border-radius:14px;background:var(--dangerbg);color:var(--danger);border:1px solid #fecaca;margin-top:10px;}
    .ok{padding:12px 14px;border-radius:14px;background:var(--okbg);color:var(--ok);border:1px solid #bbf7d0;margin-top:10px;}
    .muted{color:var(--muted);}

    /* Pack pills */
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px;
      border:1px solid var(--line);
      background:#fff;
    }
    .pill.ok{ background:var(--okbg); border-color:#bbf7d0; color:var(--ok); }
    .pill.no{ background:#f1f5f9; border-color:#e2e8f0; color:#334155; }
    tr.dim{ opacity:.55; }

    /* Bottom tabs (responsive) */
    .tabs{
      position:fixed;left:0;right:0;bottom:0;
      background:#fff;border-top:1px solid #e2e8f0;
      display:flex;justify-content:center;gap:10px;
      padding:10px;
      z-index:50;
    }
    .tabbtn{
      flex:1;
      background:#f1f5f9;color:#0f172a;
      border-radius:16px;padding:10px 12px;
      display:flex;align-items:center;justify-content:center;
      gap:8px;font-weight:800;
      min-width:0;
      white-space:nowrap;
      user-select:none;
    }
    .tabbtn span.label{
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tabbtn.active{background:#0f172a;color:#fff;}
    .hidden{display:none;}

    /* Desktop: que no se vean mini */
    @media (min-width: 900px){
      .tabs{gap:14px;padding:12px;}
      .tabbtn{max-width:260px;padding:12px 14px;font-size:16px;}
    }
    /* Mobile: que calcen en 1 fila */
    @media (max-width: 480px){
      .tabs{gap:8px;padding:10px;}
      .tabbtn{padding:10px 10px;font-size:14px;border-radius:14px;}
    }

    /* Modal */
    .modalOverlay{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:99;}
    .modal{background:#fff;border-radius:18px;max-width:520px;width:100%;padding:18px;box-shadow:0 18px 40px rgba(0,0,0,.25);border:1px solid var(--line);}
    .modal h3{margin:0 0 8px;}
    .modal p{margin:0 0 14px;color:var(--muted);}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;}
    .btnGhost{background:#e2e8f0;color:#0f172a;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Panel de Supervisi√≥n ¬∑ Welcome Pack</h1>

    <!-- REGISTRAR -->
    <section id="view-registrar" class="card">
      <h2 style="margin:0 0 10px;">Registrar entrega (admin)</h2>

      <div class="row">
        <input id="rutBuscar" placeholder="RUT abonado o comprador (con o sin gui√≥n)" />
        <button id="btnBuscar">Buscar</button>
      </div>

      <div id="buscarMsg"></div>

      <div id="groupBox" style="display:none;margin-top:10px;">
        <div id="groupHeader" style="font-weight:800;margin-bottom:8px;"></div>
        <div id="groupSummary" class="muted" style="margin-bottom:10px;"></div>

        <table>
          <thead>
            <tr>
              <th>Pack</th>
              <th>Rut</th>
              <th>Nombre</th>
              <th>Categor√≠a</th>
              <th>Ubicaci√≥n</th>
              <th>Fila</th>
              <th>Asiento</th>
            </tr>
          </thead>
          <tbody id="groupTbody"></tbody>
        </table>

        <div id="statusBox"></div>

        <div id="formEntrega" style="margin-top:14px; display:none;">
          <h3 style="margin:0 0 10px;">Datos del receptor</h3>
          <div class="row">
            <input id="rutReceptor" placeholder="RUT receptor (con o sin gui√≥n)"/>
            <input id="nombreReceptor" placeholder="Nombre receptor"/>
            <button id="btnGuardar">Guardar entrega</button>
          </div>
        </div>
      </div>
    </section>

    <!-- EXPORTAR -->
    <section id="view-exportar" class="card hidden">
      <h2 style="margin:0 0 10px;">Exportar</h2>
      <div class="row">
        <button onclick="window.open('/.netlify/functions/export_base','_blank')">Descargar base (Excel)</button>
        <button onclick="window.open('/.netlify/functions/export_log','_blank')">Descargar entregas (Excel)</button>
      </div>
      <div class="muted" style="margin-top:10px;">
        Descarga directa en formato Excel (.xls).
      </div>
    </section>

    <!-- METRICAS -->
    <section id="view-metricas" class="card hidden">
      <div class="row" style="justify-content:space-between;">
        <h2 style="margin:0;">M√©tricas (resumen)</h2>
        <button id="btnMetrics">Actualizar</button>
      </div>
      <div id="metricsBox" style="margin-top:10px;"></div>
    </section>
  </div>

  <!-- TABS ABAJO -->
  <div class="tabs">
    <div class="tabbtn active" data-tab="registrar">üìù <span class="label">Registrar</span></div>
    <div class="tabbtn" data-tab="exportar">‚¨áÔ∏è <span class="label">Exportar</span></div>
    <div class="tabbtn" data-tab="metricas">üìä <span class="label">M√©tricas</span></div>
  </div>

  <!-- MODAL -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal">
      <h3 id="modalTitle">Aviso</h3>
      <p id="modalText"></p>
      <div class="actions">
        <button class="btnGhost" id="modalClose">Cerrar</button>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  // modal
  const modalOverlay = $("modalOverlay");
  const modalTitle = $("modalTitle");
  const modalText = $("modalText");
  const modalClose = $("modalClose");
  function showModal(title, text){
    modalTitle.textContent = title || "Aviso";
    modalText.textContent = text || "";
    modalOverlay.style.display = "flex";
  }
  modalClose.onclick = ()=> modalOverlay.style.display="none";
  modalOverlay.addEventListener("click",(e)=>{ if(e.target===modalOverlay) modalOverlay.style.display="none"; });

  // tabs
  const views = {
    registrar: $("view-registrar"),
    exportar: $("view-exportar"),
    metricas: $("view-metricas")
  };
  document.querySelectorAll(".tabbtn").forEach(btn=>{
    btn.onclick = async ()=>{
      document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      Object.values(views).forEach(v=>v.classList.add("hidden"));
      views[btn.dataset.tab].classList.remove("hidden");

      if(btn.dataset.tab === "metricas"){
        await loadMetrics();
      }
    };
  });

  // registrar
  const rutBuscar = $("rutBuscar");
  const btnBuscar = $("btnBuscar");
  const buscarMsg = $("buscarMsg");
  const groupBox = $("groupBox");
  const groupHeader = $("groupHeader");
  const groupSummary = $("groupSummary");
  const groupTbody = $("groupTbody");
  const statusBox = $("statusBox");
  const formEntrega = $("formEntrega");
  const rutReceptor = $("rutReceptor");
  const nombreReceptor = $("nombreReceptor");
  const btnGuardar = $("btnGuardar");

  let lastData = null;

  function sortMiembros(miembros){
    const arr = Array.isArray(miembros) ? [...miembros] : [];
    arr.sort((a,b)=>{
      const ap = a.pack_corresponde ? 1 : 0;
      const bp = b.pack_corresponde ? 1 : 0;
      if (bp !== ap) return bp - ap;
      return String(a.nombre||"").localeCompare(String(b.nombre||""), "es");
    });
    return arr;
  }

  function renderGroup(data){
    lastData = data;
    groupBox.style.display = "block";
    groupTbody.innerHTML = "";
    statusBox.innerHTML = "";
    formEntrega.style.display = "none";

    const packsAEntregar = Number(data.packs_a_entregar || 0);
    const sinPack = Number(data.sin_pack || 0);

    groupHeader.textContent =
      `Estado: ${data.status} ¬∑ RUT buscado: ${data.buscado?.rut || ""} ¬∑ Nombre: ${data.buscado?.nombre || "-"}`;

    groupSummary.textContent =
      `Comprador: ${data.comprador?.nombre || "-"} (${data.comprador?.rut || "-"}) ¬∑ Packs a entregar: ${packsAEntregar} ¬∑ Sin pack: ${sinPack}`;

    const miembrosOrdenados = sortMiembros(data.miembros || []);

    miembrosOrdenados.forEach(m=>{
      const corresponde = !!m.pack_corresponde;
      const pill = corresponde
        ? `<span class="pill ok">‚úÖ ${m.pack || "SI"}</span>`
        : `<span class="pill no">‚ùå NO</span>`;
      const tr = document.createElement("tr");
      if(!corresponde) tr.classList.add("dim");

      tr.innerHTML = `
        <td>${pill}</td>
        <td>${m.rut||""}</td>
        <td>${m.nombre||""}</td>
        <td>${m.categoria||""}</td>
        <td>${m.ubicacion||""}</td>
        <td>${m.fila||""}</td>
        <td>${m.asiento||""}</td>
      `;
      groupTbody.appendChild(tr);
    });

    // banners
    if(data.status === "NO_CORRESPONDE" || packsAEntregar === 0){
      const div = document.createElement("div");
      div.className = "alert";
      div.textContent = "Este grupo no tiene welcome pack.";
      statusBox.appendChild(div);
      return;
    }

    if(data.status === "YA_ENTREGADO"){
      const div = document.createElement("div");
      div.className = "ok";
      div.textContent = "Welcome packs ya entregados a este grupo.";
      statusBox.appendChild(div);
      return;
    }

    // si llega ac√°: PENDIENTE y con packs
    formEntrega.style.display = "block";
  }

  async function buscar(){
    const rut = rutBuscar.value.trim();
    buscarMsg.innerHTML = "";
    groupBox.style.display = "none";
    lastData = null;

    if(!rut){
      showModal("Falta RUT", "Ingresa un RUT para buscar.");
      return;
    }

    btnBuscar.disabled = true;
    try{
      const res = await fetch(`/.netlify/functions/buscar?rut=${encodeURIComponent(rut)}`);
      const data = await res.json();

      if(data.status === "NO_ENCONTRADO"){
        showModal("No encontrado", "No se encontr√≥ el RUT en la base.");
        return;
      }
      if(data.status === "ERROR"){
        showModal("Error", data.error || "Error desconocido");
        return;
      }

      renderGroup(data);
    }catch(e){
      showModal("Error al cargar", String(e?.message || e));
    }finally{
      btnBuscar.disabled = false;
    }
  }

  btnBuscar.onclick = buscar;
  rutBuscar.addEventListener("keydown",(e)=>{ if(e.key==="Enter") buscar(); });

  async function guardar(){
    if(!lastData){
      showModal("Sin grupo", "Primero busca un RUT.");
      return;
    }

    const packsAEntregar = Number(lastData.packs_a_entregar || 0);
    if(lastData.status === "NO_CORRESPONDE" || packsAEntregar === 0){
      showModal("No corresponde", "Este grupo no tiene welcome pack.");
      return;
    }
    if(lastData.status === "YA_ENTREGADO"){
      showModal("Ya entregado", "Welcome packs ya entregados a este grupo.");
      return;
    }

    const body = {
      rut_buscado: lastData.buscado?.rut || rutBuscar.value.trim(),
      rut_receptor: rutReceptor.value.trim(),
      nombre_receptor: nombreReceptor.value.trim()
    };

    if(!body.rut_receptor || !body.nombre_receptor){
      showModal("Faltan datos", "Completa RUT receptor y nombre receptor.");
      return;
    }

    btnGuardar.disabled = true;
    try{
      const res = await fetch("/.netlify/functions/entregar", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();

      if(data.status === "YA_ENTREGADO"){
        showModal("Ya entregado", "Este grupo ya ten√≠a entrega registrada.");
        await buscar();
        return;
      }
      if(data.status === "NO_CORRESPONDE"){
        showModal("No corresponde", "Este grupo no tiene welcome pack.");
        await buscar();
        return;
      }
      if(data.status !== "OK"){
        showModal("Error", data.error || "No se pudo guardar.");
        return;
      }

      showModal("Listo ‚úÖ", `Entrega registrada correctamente.`);
      rutReceptor.value = "";
      nombreReceptor.value = "";
      await buscar();
    }catch(e){
      showModal("Error", String(e?.message || e));
    }finally{
      btnGuardar.disabled = false;
    }
  }

  btnGuardar.onclick = guardar;

  // M√©tricas
  const btnMetrics = $("btnMetrics");
  const metricsBox = $("metricsBox");

  function fmtPct(x){
    const v = Number(x || 0) * 100;
    return `${v.toFixed(1)}%`;
  }

  async function loadMetrics(){
    metricsBox.innerHTML = `<div class="muted">Cargando...</div>`;
    btnMetrics.disabled = true;
    try{
      const res = await fetch("/.netlify/functions/metrics");
      const data = await res.json();
      if(data.status !== "OK"){
        metricsBox.innerHTML = `<div class="alert">${data.error || "No se pudo cargar m√©tricas"}</div>`;
        return;
      }

      const cards = `
        <div class="row" style="margin-top:10px;">
          <div class="card" style="flex:1; margin:0; border:1px solid var(--line);">
            <div class="muted">Total welcome packs</div>
            <div style="font-size:34px; font-weight:900;">${data.total_base ?? 0}</div>
          </div>
          <div class="card" style="flex:1; margin:0; border:1px solid var(--line);">
            <div class="muted">Entregados</div>
            <div style="font-size:34px; font-weight:900;">${data.total_entregados ?? 0}</div>
          </div>
          <div class="card" style="flex:1; margin:0; border:1px solid var(--line);">
            <div class="muted">% Entrega</div>
            <div style="font-size:34px; font-weight:900;">${fmtPct(data.pct_total)}</div>
          </div>
        </div>
      `;

      const catRows = (data.por_categoria || []).map(r=>`
        <tr>
          <td>${r.categoria}</td>
          <td>${r.entregados}</td>
          <td>${r.base}</td>
          <td>${fmtPct(r.pct)}</td>
        </tr>
      `).join("");

      const tsRows = (data.por_ubicacion || data.por_tribuna_sector || []).map(r=>`
        <tr>
          <td>${r.ubicacion || r.tribuna || ""}</td>
          <td>${r.entregados}</td>
          <td>${r.base}</td>
          <td>${fmtPct(r.pct)}</td>
        </tr>
      `).join("");

      metricsBox.innerHTML = `
        ${cards}

        <h3 style="margin:18px 0 8px;">Por categor√≠a</h3>
        <table>
          <thead><tr><th>Categor√≠a</th><th>Entregados</th><th>Total</th><th>% Entrega</th></tr></thead>
          <tbody>${catRows || ""}</tbody>
        </table>

        <h3 style="margin:18px 0 8px;">Por ubicaci√≥n</h3>
        <div class="muted">Agrupado por PRIETO / LEPE / FOUILLIOUX / LIVINGSTONE / PREMIUM SEAT.</div>
        <table>
          <thead><tr><th>Ubicaci√≥n</th><th>Entregados</th><th>Total</th><th>% Entrega</th></tr></thead>
          <tbody>${tsRows || ""}</tbody>
        </table>

        <div class="muted" style="margin-top:10px;">Actualizado: ${data.updated_at || ""}</div>
      `;
    }catch(e){
      metricsBox.innerHTML = `<div class="alert">${String(e?.message || e)}</div>`;
    }finally{
      btnMetrics.disabled = false;
    }
  }

  btnMetrics.onclick = loadMetrics;
</script>
</body>
</html>
