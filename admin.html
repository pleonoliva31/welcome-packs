<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Supervisión · Welcome Pack</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { padding-bottom: 76px; }
    .tab { display: none; }
    .tab.active { display: block; }
    .bottom-nav { position: fixed; left:0; right:0; bottom:0; z-index:50; background:rgba(255,255,255,.95); border-top:1px solid #e5e7eb; }
    .bottom-nav button[aria-selected="true"] { background:#111827; color:#fff; }
    .table-wrap { overflow:auto; }
    th, td { white-space: nowrap; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <main class="max-w-7xl mx-auto p-4 space-y-4">
    <h1 class="text-xl font-bold">Panel de Supervisión · Welcome Pack</h1>

    <!-- Tabs -->
    <section id="tab-registrar" class="tab active bg-white rounded-2xl shadow p-4 space-y-3">
      <h2 class="text-lg font-semibold">Registrar entrega (admin)</h2>
      <div class="flex gap-2 flex-wrap">
        <input id="adm-rut" class="border px-3 py-2 rounded-xl flex-1 min-w-[220px]" placeholder="RUT comprador/asociado">
        <button id="adm-buscar" class="px-4 py-2 rounded-xl bg-black text-white">Buscar</button>
      </div>
      <div id="adm-resultado" class="text-sm"></div>

      <div id="adm-form-receptor" class="hidden bg-gray-50 border rounded-xl p-3 space-y-2">
        <div class="flex gap-2 flex-wrap">
          <input id="adm-receptor-rut" class="border px-3 py-2 rounded-xl flex-1 min-w-[220px]" placeholder="RUT de quien retira">
          <input id="adm-receptor-nombre" class="border px-3 py-2 rounded-xl flex-1 min-w-[220px]" placeholder="Nombre de quien retira">
          <button id="adm-entregar" class="px-4 py-2 rounded-xl bg-green-600 text-white">Entregar TODO</button>
        </div>
        <p class="text-xs text-gray-600">El receptor debe pertenecer al mismo abono.</p>
      </div>

      <div id="adm-msg" class="text-sm"></div>
    </section>

    <section id="tab-reporte" class="tab bg-white rounded-2xl shadow p-4 space-y-3">
      <h2 class="text-lg font-semibold">Reporte Welcome Pack (base actualizada)</h2>
      <div class="flex gap-2 flex-wrap">
        <input id="rep-buscar" class="border px-3 py-2 rounded-xl flex-1 min-w-[220px]" placeholder="Buscar por RUT / nombre / tribuna / sector">
        <button id="rep-refresh" class="px-4 py-2 rounded-xl bg-black text-white">Actualizar</button>
      </div>
      <div id="rep-status" class="text-sm text-gray-500">Cargando…</div>
      <div class="table-wrap border rounded-xl">
        <table class="min-w-full text-sm">
          <thead id="rep-head" class="bg-gray-100"></thead>
          <tbody id="rep-body"></tbody>
        </table>
      </div>
      <div class="flex items-center justify-between text-sm">
        <div id="rep-count" class="text-gray-600"></div>
        <div class="flex gap-2">
          <button id="rep-prev" class="px-3 py-1 rounded border">« Anterior</button>
          <button id="rep-next" class="px-3 py-1 rounded border">Siguiente »</button>
        </div>
      </div>
    </section>

    <section id="tab-metricas" class="tab bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-semibold mb-3">Métricas (resumen)</h2>
      <div id="met-resumen" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
      <div class="mt-3 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="bg-gray-50 rounded-xl border p-3">
          <h3 class="font-medium mb-2">Por categoría</h3>
          <div class="table-wrap">
            <table class="min-w-full text-sm"><thead class="bg-white">
              <tr><th class="px-2 py-1 border-b">Categoría</th><th class="px-2 py-1 border-b">Entregados</th><th class="px-2 py-1 border-b">Total</th><th class="px-2 py-1 border-b">% Entrega</th></tr>
            </thead><tbody id="met-cats"></tbody></table>
          </div>
        </div>
        <div class="bg-gray-50 rounded-xl border p-3">
          <h3 class="font-medium mb-2">Por tribuna/sector</h3>
          <div class="table-wrap">
            <table class="min-w-full text-sm"><thead class="bg-white">
              <tr><th class="px-2 py-1 border-b">Tribuna</th><th class="px-2 py-1 border-b">Entregados</th><th class="px-2 py-1 border-b">Total</th><th class="px-2 py-1 border-b">% Entrega</th></tr>
            </thead><tbody id="met-tribs"></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-entregas" class="tab bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-semibold mb-2">Entregas (agrupadas)</h2>
      <div class="flex gap-2 flex-wrap">
        <input id="log-buscar" class="border px-3 py-2 rounded-xl flex-1 min-w-[220px]" placeholder="Buscar por receptor/comprador">
        <button id="log-refresh" class="px-4 py-2 rounded-xl bg-black text-white">Actualizar</button>
      </div>
      <div class="table-wrap border rounded-xl mt-2">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-1 border-b">Nombre receptor</th>
              <th class="px-2 py-1 border-b">Rut receptor</th>
              <th class="px-2 py-1 border-b">Nombre comprador</th>
              <th class="px-2 py-1 border-b">Rut comprador</th>
              <th class="px-2 py-1 border-b">Total packs</th>
              <th class="px-2 py-1 border-b">Detalle por categoría</th>
            </tr>
          </thead>
          <tbody id="log-body"></tbody>
        </table>
      </div>
      <div class="flex items-center justify-between text-sm mt-2">
        <div id="log-count" class="text-gray-600"></div>
        <div class="flex gap-2">
          <button id="log-prev" class="px-3 py-1 rounded border">« Anterior</button>
          <button id="log-next" class="px-3 py-1 rounded border">Siguiente »</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom nav -->
  <nav class="bottom-nav">
    <div class="grid grid-cols-4 gap-2 p-2">
      <button class="px-2 py-2 rounded-xl border" data-tab="registrar" aria-selected="true">📝 Registrar</button>
      <button class="px-2 py-2 rounded-xl border" data-tab="reporte"  aria-selected="false">📋 Reporte</button>
      <button class="px-2 py-2 rounded-xl border" data-tab="metricas" aria-selected="false">📊 Métricas</button>
      <button class="px-2 py-2 rounded-xl border" data-tab="entregas" aria-selected="false">📦 Entregas</button>
    </div>
  </nav>

  <!-- Modal de error + sugerencias -->
  <div id="error-modal" class="fixed inset-0 z-[9999] hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative mx-4 w-full max-w-md rounded-2xl bg-white p-5 shadow-2xl">
      <h3 class="mb-2 text-lg font-semibold text-red-700">Atención</h3>
      <p id="error-modal-text" class="text-sm text-gray-800">Ocurrió un problema.</p>
      <div id="rut-sugerencias" class="mt-3 hidden">
        <h4 class="text-sm font-medium mb-2">¿Quizás buscabas uno de estos?</h4>
        <div id="rut-sug-list" class="space-y-2"></div>
      </div>
      <div class="mt-4 flex justify-end">
        <button id="error-modal-continue" class="px-4 py-2 rounded-xl bg-black text-white text-sm">Continuar con nuevo registro</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Tabs ----------
    const tabsBtns = document.querySelectorAll('.bottom-nav [data-tab]');
    const tabs = {
      registrar: document.getElementById('tab-registrar'),
      reporte:   document.getElementById('tab-reporte'),
      metricas:  document.getElementById('tab-metricas'),
      entregas:  document.getElementById('tab-entregas')
    };
    tabsBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tabsBtns.forEach(b=>b.setAttribute('aria-selected','false'));
        btn.setAttribute('aria-selected','true');
        Object.values(tabs).forEach(p=>p.classList.remove('active'));
        tabs[btn.dataset.tab].classList.add('active');

        if(btn.dataset.tab==='reporte') loadReporte();
        if(btn.dataset.tab==='metricas') loadMetricas();
        if(btn.dataset.tab==='entregas') loadLog();
      });
    });

    // ---------- Modal ----------
    function openErrorModal(text, opciones = []) {
      document.getElementById('error-modal-text').textContent = text || 'Ocurrió un problema.';
      const m = document.getElementById('error-modal');
      m.classList.remove('hidden'); m.classList.add('flex');

      // sugerencias (si vienen)
      const sugWrap = document.getElementById('rut-sugerencias');
      const list = document.getElementById('rut-sug-list');
      if (opciones && opciones.length) {
        list.innerHTML = opciones.map(o => `
          <div class="flex items-center justify-between border rounded-xl p-2">
            <div class="text-sm">
              <div class="font-medium">${esc(o.nombre || '-')}</div>
              <div class="text-gray-600">${esc(o.rut || '')}</div>
              <div class="text-xs text-gray-500">Comprador: ${esc(o.nombre_comprador||'-')} (${esc(o.rut_comprador||'')})</div>
            </div>
            <button class="ml-2 px-3 py-1 rounded-lg bg-blue-600 text-white text-xs" data-fill-rut="${esc(o.rut||'')}">Usar este RUT</button>
          </div>
        `).join('');
        sugWrap.classList.remove('hidden');

        // eventos de “Usar este RUT”
        list.querySelectorAll('[data-fill-rut]').forEach(b=>{
          b.addEventListener('click', ()=>{
            const rut = b.getAttribute('data-fill-rut');
            // Lo ponemos en el campo receptor para registrar
            document.getElementById('adm-receptor-rut').value = rut;
            closeErrorModalAndReset(false); // no full reset para que siga en el flujo
          });
        });
      } else {
        sugWrap.classList.add('hidden');
        list.innerHTML = '';
      }
    }
    function closeErrorModalAndReset(full = true){
      const m = document.getElementById('error-modal');
      m.classList.add('hidden'); m.classList.remove('flex');
      if(full){
        document.getElementById('adm-rut').value='';
        document.getElementById('adm-receptor-rut').value='';
        document.getElementById('adm-receptor-nombre').value='';
        document.getElementById('adm-resultado').innerHTML='';
        document.getElementById('adm-msg').innerHTML='';
        document.getElementById('adm-form-receptor').classList.add('hidden');
      }
    }
    document.getElementById('error-modal-continue').addEventListener('click', ()=>closeErrorModalAndReset(true));
    document.querySelector('#error-modal .absolute').addEventListener('click', ()=>closeErrorModalAndReset(true));
    document.addEventListener('keydown', e=>{
      if(e.key==='Escape'){
        const m=document.getElementById('error-modal');
        if(!m.classList.contains('hidden')) closeErrorModalAndReset(true);
      }
    });

    // ---------- Utils ----------
    const esc = v => String(v ?? '').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));

    // ---------- Registrar (admin) ----------
    document.getElementById('adm-buscar').addEventListener('click', adminBuscar);
    document.getElementById('adm-entregar').addEventListener('click', adminRegistrar);

    async function adminBuscar(){
      const rut = document.getElementById('adm-rut').value.trim();
      if(!rut) return;

      try{
        const res = await fetch('/.netlify/functions/buscar?rut='+encodeURIComponent(rut), {cache:'no-store'});
        const out = await res.json();

        if(out.status === 'NO_BASE'){
          // sugerencias de RUT similares
          const sug = await pedirSugerencias(rut);
          openErrorModal('No se encontró el RUT en la base.', sug);
          document.getElementById('adm-resultado').innerHTML = '';
          document.getElementById('adm-form-receptor').classList.add('hidden');
          return;
        }

        renderGrupo(out);
      }catch(e){
        openErrorModal('Error de red: ' + e.message);
      }
    }

    function renderGrupo(out){
      const cont = document.getElementById('adm-resultado');
      const form = document.getElementById('adm-form-receptor');
      const msg  = document.getElementById('adm-msg');

      msg.innerHTML = '';
      if(!out || !out.grupo){
        cont.innerHTML = '<div class="p-2 bg-red-50 text-red-700 rounded">Sin datos para mostrar.</div>';
        form.classList.add('hidden');
        return;
      }
      const g = out.grupo;
      const resumen = (g.miembros||[]).reduce((acc,m)=>{
        const k=(m.categoria||'').toUpperCase(); acc[k]=(acc[k]||0)+1; return acc;
      },{});
      const resStr = Object.entries(resumen).map(([k,v])=>`${v} - ${k}`).join(' · ') || '-';

      cont.innerHTML = `
        <div class="space-y-2">
          <div class="p-3 border rounded-xl bg-gray-50">
            <div><b>Estado:</b> ${esc(out.status)}</div>
            <div><b>Comprador:</b> ${esc(g?.comprador?.nombre_comprador||'-')} (${esc(g?.comprador?.rut_comprador||'-')})</div>
            <div><b>Resumen packs:</b> ${esc(resStr)}</div>
          </div>
          <div class="table-wrap border rounded-xl">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-100 text-left">
                <tr><th class="px-2 py-1 border-b">Rut</th><th class="px-2 py-1 border-b">Nombre</th><th class="px-2 py-1 border-b">Categoría</th><th class="px-2 py-1 border-b">Tribuna</th><th class="px-2 py-1 border-b">Sector</th></tr>
              </thead>
              <tbody>
                ${(g.miembros||[]).map(m=>`
                  <tr>
                    <td class="px-2 py-1 border-b">${esc(m.rut||'')}</td>
                    <td class="px-2 py-1 border-b">${esc(m.nombre||'')}</td>
                    <td class="px-2 py-1 border-b">${esc(m.categoria||'')}</td>
                    <td class="px-2 py-1 border-b">${esc(m.tribuna||'')}</td>
                    <td class="px-2 py-1 border-b">${esc(m.sector||'')}</td>
                  </tr>`).join('')}
              </tbody>
            </table>
          </div>
        </div>`;

      if(out.status === 'PENDIENTE') form.classList.remove('hidden');
      else { form.classList.add('hidden'); msg.innerHTML = `<div class="p-2 bg-green-50 text-green-700 rounded">Grupo ya retiró sus packs.</div>`; }
    }

    async function adminRegistrar(){
      const rutBusqueda = document.getElementById('adm-rut').value.trim();
      const receptor_rut = document.getElementById('adm-receptor-rut').value.trim();
      const receptor_nombre = document.getElementById('adm-receptor-nombre').value.trim();
      if(!rutBusqueda || !receptor_rut || !receptor_nombre) return;
      try{
        const res = await fetch('/.netlify/functions/entregar',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({rut_busqueda:rutBusqueda,receptor_rut,receptor_nombre})
        });
        const out = await res.json();
        if(out.ok){
          document.getElementById('adm-msg').innerHTML = `<div class="p-2 bg-green-50 text-green-700 rounded">Entrega registrada.</div>`;
          // refresco de grupo para ver estado actualizado
          await adminBuscar();
        }else{
          // Si es “no corresponde”, pedimos sugerencias para el receptor
          if(/no\s*corresponde/i.test(out.error||"")){
            const sug = await pedirSugerencias(receptor_rut);
            openErrorModal("El RUT ingresado no corresponde a este abono.", sug);
          }else{
            openErrorModal(out.error || "Error al registrar");
          }
        }
      }catch(e){
        openErrorModal('Error de red: ' + e.message);
      }
    }

    // ---------- Sugerencias ----------
    async function pedirSugerencias(rut) {
      try{
        const res = await fetch('/.netlify/functions/rut_sugerencias?rut='+encodeURIComponent(rut), {cache:'no-store'});
        const data = await res.json();
        if(data && data.ok) return data.sugerencias || [];
      }catch(e){ /* silencioso */ }
      return [];
    }

    // ---------- Reporte ----------
    let REP = []; let repPage = 1; const repSize = 50;
    async function loadReporte(){
      document.getElementById('rep-status').textContent = 'Cargando…';
      const r = await fetch('/.netlify/functions/export_base',{cache:'no-store'});
      const data = await r.json();
      REP = Array.isArray(data) ? data : [];
      repPage = 1;
      renderReporte(true);
      document.getElementById('rep-status').textContent = '';
    }
    function renderReporte(reset){
      if(reset) repPage = 1;
      const q = (document.getElementById('rep-buscar').value || '').toLowerCase();
      const head = document.getElementById('rep-head');
      const body = document.getElementById('rep-body');
      const count= document.getElementById('rep-count');

      const cols = [
        {key:'rut',label:'Rut'},{key:'nombre',label:'Nombre'},
        {key:'categoria',label:'Categoría'},{key:'tribuna',label:'Tribuna'},
        {key:'sector',label:'Sector'},{key:'entregado',label:'Entregado'},
        {key:'fecha_entrega',label:'Fecha entrega'},{key:'rut_receptor',label:'Rut receptor'}
      ];
      head.innerHTML = `<tr>${cols.map(c=>`<th class="px-2 py-1 border-b">${c.label}</th>`).join('')}</tr>`;

      const filtered = REP.filter(r =>
        !q || (String(r.rut||'').includes(q)) || (String(r.nombre||'').toLowerCase().includes(q)) ||
        (String(r.tribuna||'').toLowerCase().includes(q)) || (String(r.sector||'').toLowerCase().includes(q))
      );
      const start = (repPage-1)*repSize;
      const pageRows = filtered.slice(start, start+repSize);

      body.innerHTML = pageRows.map(r=>`
        <tr>${cols.map(c=>`<td class="px-2 py-1 border-b">${esc(r[c.key]||'')}</td>`).join('')}</tr>
      `).join('');
      count.textContent = `Mostrando ${pageRows.length} de ${filtered.length} registros · Página ${repPage}`;

      document.getElementById('rep-prev').onclick = ()=>{ if(repPage>1){ repPage--; renderReporte(); } };
      document.getElementById('rep-next').onclick = ()=>{ if(repPage*repSize<filtered.length){ repPage++; renderReporte(); } };
      document.getElementById('rep-refresh').onclick = loadReporte;
      document.getElementById('rep-buscar').oninput = ()=> renderReporte(true);
    }

    // ---------- Métricas ----------
    async function loadMetricas(){
      const res = await fetch('/.netlify/functions/metrics',{cache:'no-store'});
      const data = await res.json();
      document.getElementById('met-resumen').innerHTML = `
        <div class="bg-white rounded-xl border p-3"><div class="text-sm text-gray-500">Total abonados</div><div class="text-2xl font-semibold">${data.total||0}</div></div>
        <div class="bg-white rounded-xl border p-3"><div class="text-sm text-gray-500">Entregados</div><div class="text-2xl font-semibold">${data.entregados||0}</div></div>
        <div class="bg-white rounded-xl border p-3"><div class="text-sm text-gray-500">% Entrega</div><div class="text-2xl font-semibold">${data.porc_total||0}%</div></div>
      `;
      document.getElementById('met-cats').innerHTML = (data.categorias||[]).map(c=>`
        <tr><td class="px-2 py-1 border-b">${esc(c.cat||'-')}</td><td class="px-2 py-1 border-b">${esc(c.entregados||0)}</td><td class="px-2 py-1 border-b">${esc(c.total||0)}</td><td class="px-2 py-1 border-b">${esc(c.porc||0)}%</td></tr>
      `).join('');
      document.getElementById('met-tribs').innerHTML = (data.tribunas||[]).map(t=>`
        <tr><td class="px-2 py-1 border-b">${esc(t.tribuna||'-')}</td><td class="px-2 py-1 border-b">${esc(t.entregados||0)}</td><td class="px-2 py-1 border-b">${esc(t.total||0)}</td><td class="px-2 py-1 border-b">${esc(t.porc||0)}%</td></tr>
      `).join('');
    }

    // ---------- Log ----------
    let LOG=[]; let logPage=1; const logSize=50;
    async function loadLog(){
      const r = await fetch('/.netlify/functions/get_log',{cache:'no-store'});
      LOG = await r.json(); logPage=1; renderLog(true);
      document.getElementById('log-refresh').onclick = loadLog;
      document.getElementById('log-buscar').oninput = ()=> renderLog(true);
      document.getElementById('log-prev').onclick = ()=>{ if(logPage>1){ logPage--; renderLog(); } };
      document.getElementById('log-next').onclick = ()=>{
        const rows = filterLog();
        if(logPage*logSize<rows.length){ logPage++; renderLog(); }
      };
    }
    function filterLog(){
      const q=(document.getElementById('log-buscar').value||'').toLowerCase();
      return LOG.filter(r =>
        !q || String(r.nombre_receptor||'').toLowerCase().includes(q) ||
              String(r.rut_receptor||'').includes(q) ||
              String(r.nombre_comprador||'').toLowerCase().includes(q) ||
              String(r.rut_comprador||'').includes(q) ||
              String(r.detalle_texto||'').toLowerCase().includes(q)
      );
    }
    function renderLog(reset){
      if(reset) logPage=1;
      const rows = filterLog();
      const start=(logPage-1)*logSize, page=rows.slice(start,start+logSize);
      document.getElementById('log-body').innerHTML = page.map(r=>{
        const det = r.detalle_texto || (r.detalle||[]).map(d=>`${d.cantidad} ${d.cat}`).join(' · ');
        return `<tr>
          <td class="px-2 py-1 border-b">${esc(r.nombre_receptor||'')}</td>
          <td class="px-2 py-1 border-b">${esc(r.rut_receptor||'')}</td>
          <td class="px-2 py-1 border-b">${esc(r.nombre_comprador||'')}</td>
          <td class="px-2 py-1 border-b">${esc(r.rut_comprador||'')}</td>
          <td class="px-2 py-1 border-b">${esc(r.total_packs||0)}</td>
          <td class="px-2 py-1 border-b">${esc(det)}</td>
        </tr>`;
      }).join('');
      document.getElementById('log-count').textContent =
        `Mostrando ${page.length} de ${rows.length} entregas · Página ${logPage}`;
    }

    // Carga inicial
    // show “Registrar” activo por defecto (ya está)
  </script>
</body>
</html>
