<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Supervisi√≥n ¬∑ Welcome Pack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-btn[aria-selected="true"] { background: #111827; color: white; }
    .table-wrap { overflow: auto; }
    th, td { white-space: nowrap; }
    /* Controles responsivos */
    .controls { display:flex; flex-wrap:wrap; gap:.5rem; }
    .controls .grow-item { flex:1 1 220px; min-width:0; }
    .controls .shrink-item { flex:0 0 auto; }
    @media (max-width:640px){ .controls .shrink-item{ width:100%; } }
    /* Barra de tabs abajo */
    body { padding-bottom: 72px; }
    .bottom-tabs {
      position: fixed; left: 0; right: 0; bottom: 0;
      z-index: 50;
      backdrop-filter: saturate(120%) blur(6px);
      background: rgba(255,255,255,.9);
      border-top: 1px solid rgba(0,0,0,.08);
      padding: .5rem .75rem;
    }
    .bottom-tabs .tab-btn {
      flex: 1 1 auto;
      justify-content: center;
      gap: .5rem;
    }
    .tabs-grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:.5rem; }
    @media (min-width:640px){ .tabs-grid { grid-template-columns: repeat(4, minmax(0,1fr)); } }
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-5xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-lg md:text-xl font-semibold">Panel de Supervisi√≥n ¬∑ Welcome Pack</h1>
      <a href="/" class="text-sm text-blue-600 underline">‚Üê Ir a vista de voluntarios</a>
    </div>

    <!-- Contenido de pesta√±as -->
    <section id="tab-metrics" class="tab-panel">
      <h2 class="text-lg font-medium mb-2">M√©tricas generales</h2>
      <div id="metrics-content" class="text-sm text-gray-700">Cargando m√©tricas...</div>
    </section>

    <section id="tab-reporte" class="tab-panel hidden">
      <div class="flex items-start justify-between gap-2 flex-wrap">
        <h2 class="text-lg font-medium">Reporte Welcome Pack (base actualizada)</h2>
        <div class="controls w-full sm:w-auto">
          <input id="reporte-search" class="grow-item px-3 py-2 rounded-xl border text-sm"
                 placeholder="Buscar por RUT o nombre...">
          <button id="reporte-refresh"
                  class="shrink-item px-3 py-2 rounded-xl bg-black text-white text-sm">
            Actualizar
          </button>
        </div>
      </div>
      <div id="reporte-table" class="mt-4 table-wrap text-sm"></div>
    </section>

    <section id="tab-log" class="tab-panel hidden">
      <div class="flex items-start justify-between gap-2 flex-wrap">
        <h2 class="text-lg font-medium">Entregas registradas (log)</h2>
        <div class="controls w-full sm:w-auto">
          <input id="log-search" class="grow-item px-3 py-2 rounded-xl border text-sm"
                 placeholder="Buscar por RUT o nombre receptor...">
          <button id="log-refresh"
                  class="shrink-item px-3 py-2 rounded-xl bg-black text-white text-sm">
            Actualizar
          </button>
        </div>
      </div>
      <div id="log-table" class="mt-4 table-wrap text-sm"></div>
    </section>

    <section id="tab-entrega" class="tab-panel hidden">
      <h2 class="text-lg font-medium mb-2">Registrar entrega</h2>
      <div class="space-y-3">
        <div class="flex gap-2">
          <input id="adm-rut" class="flex-1 px-3 py-2 rounded-xl border"
                 placeholder="RUT abonado o comprador">
          <button onclick="adminBuscar()" class="px-3 py-2 rounded-xl bg-black text-white">Buscar</button>
        </div>
        <div id="adm-resultado"></div>
        <form id="adm-form-receptor" class="hidden space-y-2">
          <input id="adm-rut-receptor" class="w-full px-3 py-2 rounded-xl border"
                 placeholder="RUT de receptor">
          <input id="adm-nombre-receptor" class="w-full px-3 py-2 rounded-xl border"
                 placeholder="Nombre de receptor">
          <button type="button" onclick="adminEntregar()"
                  class="w-full px-3 py-2 rounded-xl bg-green-600 text-white">
            Confirmar entrega
          </button>
        </form>
        <div id="adm-msg" class="text-sm"></div>
      </div>
    </section>
  </div>

  <!-- Barra de pesta√±as abajo -->
  <nav class="bottom-tabs">
    <div class="tabs-grid">
      <button class="tab-btn px-3 py-2 rounded-xl border" role="tab" aria-selected="true"  data-tab="tab-metrics">üìä M√©tricas</button>
      <button class="tab-btn px-3 py-2 rounded-xl border" role="tab" aria-selected="false" data-tab="tab-reporte">üìã Reporte</button>
      <button class="tab-btn px-3 py-2 rounded-xl border" role="tab" aria-selected="false" data-tab="tab-log">üì¶ Entregas</button>
      <button class="tab-btn px-3 py-2 rounded-xl border" role="tab" aria-selected="false" data-tab="tab-entrega">üìù Registrar</button>
    </div>
  </nav>

  <!-- Modal de error receptor fuera del grupo -->
  <div id="error-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative mx-4 w-full max-w-md rounded-2xl bg-white p-5 shadow-xl">
      <h3 class="mb-2 text-lg font-semibold text-red-700">No corresponde al abono</h3>
      <p id="error-modal-text" class="text-sm text-gray-700">
        El RUT ingresado no corresponde a este abono.
      </p>
      <div class="mt-4 flex justify-end">
        <button id="error-modal-continue"
                class="px-4 py-2 rounded-xl bg-black text-white text-sm">
          Continuar con nuevo registro
        </button>
      </div>
    </div>
  </div>

  <script>
    // Tabs
    const panels = {
      'tab-metrics': document.getElementById('tab-metrics'),
      'tab-reporte': document.getElementById('tab-reporte'),
      'tab-log': document.getElementById('tab-log'),
      'tab-entrega': document.getElementById('tab-entrega')
    };
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.setAttribute('aria-selected','false'));
        btn.setAttribute('aria-selected','true');
        Object.values(panels).forEach(p=>p.classList.add('hidden'));
        panels[btn.dataset.tab].classList.remove('hidden');
        if(btn.dataset.tab==='tab-metrics') loadMetrics();
        if(btn.dataset.tab==='tab-reporte') initReporte();
        if(btn.dataset.tab==='tab-log') initLog();
      });
    });

    // Modal
    function openErrorModal(texto){
      document.getElementById('error-modal-text').textContent = texto;
      const m=document.getElementById('error-modal');
      m.classList.remove('hidden'); m.classList.add('flex');
    }
    function closeErrorModalAndReset(){
      const m=document.getElementById('error-modal');
      m.classList.add('hidden'); m.classList.remove('flex');
      document.getElementById('adm-rut').value='';
      document.getElementById('adm-resultado').innerHTML='';
      document.getElementById('adm-form-receptor').classList.add('hidden');
      document.getElementById('adm-msg').textContent='';
      document.getElementById('adm-rut').focus();
    }
    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('error-modal-continue').addEventListener('click', closeErrorModalAndReset);
      document.addEventListener('keydown',(e)=>{if(e.key==='Escape'){const m=document.getElementById('error-modal');if(!m.classList.contains('hidden')) closeErrorModalAndReset();}});
    });

    // Dummy functions: aqu√≠ ir√≠a tu l√≥gica fetch real
    async function loadMetrics(){ document.getElementById('metrics-content').textContent="(M√©tricas en vivo aqu√≠)"; }
    function initReporte(){ document.getElementById('reporte-table').textContent="(Tabla de base actualizada aqu√≠)"; }
    function initLog(){ document.getElementById('log-table').textContent="(Tabla de entregas aqu√≠)"; }

    // Registro entrega
    async function adminBuscar(){
      const rut=document.getElementById('adm-rut').value.trim();
      const res=document.getElementById('adm-resultado');
      if(!rut){res.textContent="Ingrese RUT";return;}
      res.innerHTML=`Buscando datos para <b>${rut}</b>... (demo)`;
      document.getElementById('adm-form-receptor').classList.remove('hidden');
    }
    async function adminEntregar(){
      const msg=document.getElementById('adm-msg');
      // Aqu√≠ ir√≠a tu llamada fetch real
      const fakeError=Math.random()<0.5;
      if(fakeError){
        openErrorModal('El RUT ingresado no corresponde a este abono.');
      }else{
        msg.innerHTML=`<div class="p-2 rounded bg-green-50 text-green-700">Entrega registrada exitosamente.</div>`;
      }
    }
  </script>
</body>
</html>
