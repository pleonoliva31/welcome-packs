<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Welcome Pack · Registro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .table-wrap { overflow:auto; }
    th, td { white-space: nowrap; }
    .controls { display:flex; flex-wrap:wrap; gap:.5rem; }
    .controls .grow-item { flex:1 1 220px; min-width:0; }
    .controls .shrink-item { flex:0 0 auto; }
    @media (max-width:640px){ .controls .shrink-item{ width:100%; } }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-3xl mx-auto p-4 space-y-4">
    <header class="flex items-center justify-between">
      <h1 class="text-lg md:text-xl font-semibold">Registro de entrega · Welcome Pack</h1>
      <a href="/admin" class="text-sm underline">Admin</a>
    </header>

    <!-- Paso 1: Buscar grupo -->
    <section class="bg-white rounded-2xl shadow p-4 space-y-3">
      <h2 class="text-base font-medium">1) Buscar abono</h2>
      <div class="controls">
        <input id="rut-busqueda" class="grow-item px-3 py-2 rounded-xl border text-sm" placeholder="Ingresa RUT abonado o comprador (con o sin guion)">
        <button id="btn-buscar" class="shrink-item px-3 py-2 rounded-xl bg-black text-white text-sm">Buscar</button>
      </div>
      <div id="resultado-busqueda" class="text-sm"></div>
    </section>

    <!-- Paso 2: Registrar entrega -->
    <section id="seccion-entrega" class="bg-white rounded-2xl shadow p-4 space-y-3 hidden">
      <h2 class="text-base font-medium">2) Confirmar entrega</h2>
      <p class="text-sm text-gray-700">Completa los datos de quien retira. Debe pertenecer al mismo abono.</p>
      <div class="controls">
        <input id="receptor-rut" class="grow-item px-3 py-2 rounded-xl border text-sm" placeholder="RUT de quien retira">
        <input id="receptor-nombre" class="grow-item px-3 py-2 rounded-xl border text-sm" placeholder="Nombre de quien retira">
        <button id="btn-entregar" class="shrink-item px-3 py-2 rounded-xl bg-green-600 text-white text-sm">Entregar TODO</button>
      </div>
      <div id="msg-entrega" class="text-sm"></div>
    </section>
  </div>

  <!-- Modal: receptor fuera del grupo -->
  <div id="error-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative mx-4 w-full max-w-md rounded-2xl bg-white p-5 shadow-xl">
      <h3 class="mb-2 text-lg font-semibold text-red-700">No corresponde al abono</h3>
      <p id="error-modal-text" class="text-sm text-gray-700">
        El RUT ingresado no corresponde a este abono.
      </p>
      <div class="mt-4 flex justify-end">
        <button id="error-modal-continue" class="px-4 py-2 rounded-xl bg-black text-white text-sm">
          Continuar con nuevo registro
        </button>
      </div>
    </div>
  </div>

  <script>
    // -------- Utilidades --------
    const normRut = s => (s||'').toUpperCase().replace(/[.\-]/g,'').trim();
    function escapeHtml(v){
      return String(v ?? '').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    // -------- Modal --------
    function openErrorModal(texto){
      document.getElementById('error-modal-text').textContent = texto || 'El RUT ingresado no corresponde a este abono.';
      const m = document.getElementById('error-modal'); m.classList.remove('hidden'); m.classList.add('flex');
    }
    function closeErrorModalAndReset(){
      const m = document.getElementById('error-modal'); m.classList.add('hidden'); m.classList.remove('flex');
      // Resetea todo para un nuevo registro
      document.getElementById('rut-busqueda').value = '';
      document.getElementById('resultado-busqueda').innerHTML = '';
      document.getElementById('seccion-entrega').classList.add('hidden');
      document.getElementById('receptor-rut').value = '';
      document.getElementById('receptor-nombre').value = '';
      document.getElementById('msg-entrega').textContent = '';
      document.getElementById('rut-busqueda').focus();
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('error-modal-continue').addEventListener('click', closeErrorModalAndReset);
      document.addEventListener('keydown',(e)=>{
        if(e.key==='Escape'){
          const m=document.getElementById('error-modal');
          if(!m.classList.contains('hidden')) closeErrorModalAndReset();
        }
      });
    });

    // -------- Estado simple --------
    let STATE = { rutBuscadoRaw:'', rutBuscado:'', grupo:null };

    // -------- Buscar grupo --------
    document.getElementById('btn-buscar').addEventListener('click', buscar);
    document.getElementById('rut-busqueda').addEventListener('keydown', e=>{ if(e.key==='Enter') buscar(); });

    async function buscar(){
      const input = document.getElementById('rut-busqueda');
      const rutRaw = input.value.trim();
      if(!rutRaw){ input.focus(); return; }

      const resBox = document.getElementById('resultado-busqueda');
      const entregaSec = document.getElementById('seccion-entrega');
      const msgEnt = document.getElementById('msg-entrega');

      resBox.innerHTML = 'Buscando…';
      entregaSec.classList.add('hidden');
      msgEnt.textContent = '';

      try{
        const url = '/.netlify/functions/buscar?rut='+encodeURIComponent(rutRaw);
        const res = await fetch(url, {cache:'no-store'});
        const data = await res.json();

        if(data.status === 'NO_BASE'){
          resBox.innerHTML = `<div class="p-3 rounded-xl border bg-red-50 text-red-700">No se encontró el RUT en la base.</div>`;
          return;
        }

        // Render de grupo
        STATE.rutBuscadoRaw = rutRaw;
        STATE.rutBuscado = normRut(rutRaw);
        STATE.grupo = data.grupo || null;

        const g = data.grupo;
        const resumen = (g?.miembros||[]).reduce((acc,m)=>{
          const k=(m.categoria||'').toUpperCase(); acc[k]=(acc[k]||0)+1; return acc;
        }, {});
        const resumenStr = Object.entries(resumen).map(([k,v])=>`${v} - ${k}`).join(' · ') || '-';

        resBox.innerHTML = `
          <div class="space-y-2">
            <div class="p-3 border rounded-xl bg-gray-50">
              <div><b>Estado:</b> ${escapeHtml(data.status)}</div>
              <div><b>Comprador:</b> ${escapeHtml(g?.comprador?.nombre_comprador||'-')} (${escapeHtml(g?.comprador?.rut_comprador||'-')})</div>
              <div><b>Resumen packs:</b> ${escapeHtml(resumenStr)}</div>
            </div>
            <div class="table-wrap border rounded-xl">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-100 text-left">
                  <tr>
                    <th class="px-2 py-1 border-b">Rut</th>
                    <th class="px-2 py-1 border-b">Nombre</th>
                    <th class="px-2 py-1 border-b">Categoría</th>
                    <th class="px-2 py-1 border-b">Tribuna</th>
                    <th class="px-2 py-1 border-b">Sector</th>
                  </tr>
                </thead>
                <tbody>
                  ${(g?.miembros||[]).map(m=>`
                    <tr>
                      <td class="px-2 py-1 border-b">${escapeHtml(m.rut||'')}</td>
                      <td class="px-2 py-1 border-b">${escapeHtml(m.nombre||'')}</td>
                      <td class="px-2 py-1 border-b">${escapeHtml(m.categoria||'')}</td>
                      <td class="px-2 py-1 border-b">${escapeHtml(m.tribuna||'')}</td>
                      <td class="px-2 py-1 border-b">${escapeHtml(m.sector||'')}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;

        if(data.status === 'PENDIENTE'){
          entregaSec.classList.remove('hidden');
          document.getElementById('receptor-rut').focus();
        }else{
          entregaSec.classList.add('hidden');
          msgEnt.innerHTML = `<div class="p-2 rounded bg-green-50 text-green-700">Welcome packs ya fueron entregados para este grupo.</div>`;
        }

      }catch(err){
        resBox.innerHTML = `<div class="p-3 rounded-xl border bg-red-50 text-red-700">Error al buscar: ${escapeHtml(err.message)}</div>`;
      }
    }

    // -------- Entregar --------
    document.getElementById('btn-entregar').addEventListener('click', entregar);

    async function entregar(){
      const msg = document.getElementById('msg-entrega');
      msg.textContent = '';
      if(!STATE.grupo){
        msg.innerHTML = `<div class="p-2 rounded bg-yellow-50 text-yellow-700">Busca primero un RUT válido.</div>`;
        return;
      }
      const receptor_rut = document.getElementById('receptor-rut').value.trim();
      const receptor_nombre = document.getElementById('receptor-nombre').value.trim();
      if(!receptor_rut || !receptor_nombre){
        msg.innerHTML = `<div class="p-2 rounded bg-yellow-50 text-yellow-700">Completa RUT y nombre del receptor.</div>`;
        return;
      }
      try{
        const res = await fetch('/.netlify/functions/entregar', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            rut_busqueda: STATE.rutBuscadoRaw,
            receptor_rut,
            receptor_nombre
          })
        });
        const out = await res.json();
        if(out.ok){
          msg.innerHTML = `<div class="p-2 rounded bg-green-50 text-green-700">Entrega registrada exitosamente (${out.entregados} registros).</div>`;
          // refrescar búsqueda para ver estado actualizado
          await buscar();
          // limpiar campos receptor
          document.getElementById('receptor-rut').value='';
          document.getElementById('receptor-nombre').value='';
        }else{
          const texto = out.error || 'Error al registrar entrega';
          // Si el receptor no pertenece al grupo → abrir modal
          if(/no corresponde/i.test(texto) || /no\s+corresponde\s+al\s+abono/i.test(texto)){
            openErrorModal('El RUT ingresado no corresponde a este abono.');
          }else{
            msg.innerHTML = `<div class="p-2 rounded bg-red-50 text-red-700">${escapeHtml(texto)}</div>`;
          }
        }
      }catch(err){
        msg.innerHTML = `<div class="p-2 rounded bg-red-50 text-red-700">Error de red: ${escapeHtml(err.message)}</div>`;
      }
    }
  </script>
</body>
</html>
